name:  Daily Model Retraining

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_retrain:
        description: 'Force retraining even if recent'
        required: false
        default: 'true'

env:
  PYTHON_VERSION: '3.10'

jobs:
  retrain:
    name:  Retrain Models
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name:  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name:  Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name:  Train all models
        id: training
        run: |
          echo "Starting model training at $(date)"
          python scripts/train_model.py
          echo "Training completed at $(date)"
        continue-on-error: true
      
      - name:  Read training metrics
        id: metrics
        if: always()
        run: |
          if [ -f models/training_metrics.json ]; then
            echo "metrics_exist=true" >> $GITHUB_OUTPUT
            # Extract summary for notification
            echo "METRICS<<EOF" >> $GITHUB_OUTPUT
            cat models/training_metrics.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          print(f\"Last Updated: {data['last_updated']}\")
          print(f\"Models Trained: {len(data['models'])}\")
          for symbol, m in data['models'].items():
              if 'error' not in m:
                  print(f\"  {m['name']}: RMSE \${m['rmse']:.2f} ({m['rmse_pct']:.2f}%)\")
              else:
                  print(f\"  {symbol}: FAILED - {m['error'][:50]}...\")
          "
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "metrics_exist=false" >> $GITHUB_OUTPUT
          fi
      
      - name:  Commit and push models
        if: steps.training.outcome == 'success'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add model files and metrics
          git add models/*.keras models/training_metrics.json training.log || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m " Auto-retrain models $(date +'%Y-%m-%d')" \
                       -m "Automated model retraining completed successfully." \
                       -m "See training_metrics.json for detailed results."
            git push
            echo " Models committed and pushed"
          fi
      
      - name:  Send success notification
        if: steps.training.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: " Crypto Models Retrained Successfully - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "Crypto Predictor Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            ğŸ‰ Daily Model Retraining Completed Successfully!
            
            ğŸ“… Date: ${{ github.event.repository.updated_at }}
            ğŸ”— Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            
            ğŸ“Š Training Summary:
            ${{ steps.metrics.outputs.METRICS }}
            
            ğŸ”— View Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated message from your Crypto Price Predictor.
        continue-on-error: true
      
      - name: ğŸ“§ Send failure notification
        if: steps.training.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Crypto Model Retraining FAILED - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "Crypto Predictor Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            âš ï¸ Daily Model Retraining Failed!
            
            ğŸ“… Date: ${{ github.event.repository.updated_at }}
            ğŸ”— Repository: ${{ github.repository }}
            
            Please check the workflow logs for details:
            ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated message from your Crypto Price Predictor.
        continue-on-error: true
      
      - name: ğŸ“‹ Upload training logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-logs-${{ github.run_number }}
          path: |
            training.log
            models/training_metrics.json
          retention-days: 30
      
      - name:  Final status
        if: always()
        run: |
          if [ "${{ steps.training.outcome }}" == "success" ]; then
            echo " Training completed successfully!"
            exit 0
          else
            echo "Training failed!"
            exit 1
          fi

